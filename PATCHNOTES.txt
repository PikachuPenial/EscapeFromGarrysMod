General code cleanup and optimization